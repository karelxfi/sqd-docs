export function CostCalculator() {
  // Pricing constants
  const computePrices = {
    api: {
      small: 0.04,
      medium: 0.08,
      large: 0.15,
      xlarge: 0.3,
      "2xlarge": 0.6,
    },
    processor: {
      small: 0.04,
      medium: 0.08,
      large: 0.15,
      xlarge: 0.3,
      "2xlarge": 0.6,
    },
    database: {
      small: 0.08,
      medium: 0.16,
      large: 0.33,
      xlarge: 0.66,
      "2xlarge": 1.32,
    },
  };

const storagePricePerGB = 0.5; // $/GB/month
const collocatedComputePrice = 0.02; // $/hour
const rpcPricePerMillion = 2; // $ per 1M
const rpcFreeMonthly = 2000000; // 2M free
const hoursPerMonth = 720; // 24/7

// Local state via React (React is auto-available in MDX)
const [squidType, setSquidType] = React.useState("dedicated");
const [apiProfile, setApiProfile] = React.useState("small");
const [apiReplicas, setApiReplicas] = React.useState(1);
const [processorProfile, setProcessorProfile] = React.useState("small");
const [processorCount, setProcessorCount] = React.useState(1);
const [databaseProfile, setDatabaseProfile] = React.useState("small");
const [storageGB, setStorageGB] = React.useState(50);
const [rpcRequests, setRpcRequests] = React.useState(0);
const [hibernated, setHibernated] = React.useState(false);

// Helpers (no TS)
const clampInt = (v, min, max = Number.MAX_SAFE_INTEGER) =>
Number.isFinite(v) ? Math.min(Math.max(Math.trunc(v), min), max) : min;

const clampFloat = (v, min, max = Number.MAX_SAFE_INTEGER) =>
Number.isFinite(v) ? Math.min(Math.max(v, min), max) : min;

const fmt = (n) =>
new Intl.NumberFormat(undefined, { style: "currency", currency: "USD", maximumFractionDigits: 2 }).format(n);

// Calculations
const computeCost = React.useMemo(() => {
if (hibernated) return 0;
if (squidType === "collocated") {
return collocatedComputePrice _ hoursPerMonth;
}
const apiCost = computePrices.api[apiProfile] _ clampInt(apiReplicas, 1) _ hoursPerMonth;
const processorCost = computePrices.processor[processorProfile] _ clampInt(processorCount, 1) _ hoursPerMonth;
const databaseCost = computePrices.database[databaseProfile] _ hoursPerMonth;
return apiCost + processorCost + databaseCost;
}, [hibernated, squidType, apiProfile, apiReplicas, processorProfile, processorCount, databaseProfile]);

const storageCost = React.useMemo(() => {
return clampFloat(storageGB, 0) \* storagePricePerGB;
}, [storageGB]);

const rpcCost = React.useMemo(() => {
const req = clampInt(rpcRequests, 0);
if (req <= rpcFreeMonthly) return 0;
const excess = req - rpcFreeMonthly;
return (excess / 1000000) \* rpcPricePerMillion;
}, [rpcRequests]);

const totalCost = computeCost + storageCost + rpcCost;

return (
<div className="not-prose w-full my-6 sm:my-8">
<div className="border border-gray-200 dark:border-white/10 rounded-xl p-6 bg-background-light dark:bg-background-dark">
<h3 className="text-xl font-semibold mb-6 text-gray-900 dark:text-gray-200">Cost Calculator</h3>

        <div className="space-y-6">
          {/* Squid Type */}
          <div>
            <label className="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Squid Type</label>
            <div className="flex gap-4">
              <label className="flex items-center cursor-pointer">
                <input
                  type="radio"
                  name="squidType"
                  value="dedicated"
                  checked={squidType === "dedicated"}
                  onChange={() => setSquidType("dedicated")}
                  className="mr-2"
                />
                <span className="text-gray-900 dark:text-gray-200">Dedicated</span>
              </label>
              <label className="flex items-center cursor-pointer">
                <input
                  type="radio"
                  name="squidType"
                  value="collocated"
                  checked={squidType === "collocated"}
                  onChange={() => setSquidType("collocated")}
                  className="mr-2"
                />
                <span className="text-gray-900 dark:text-gray-200">Collocated</span>
              </label>
            </div>
          </div>

          {/* Dedicated Config */}
          {squidType === "dedicated" && (
            <>
              <div>
                <label className="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">API Profile</label>
                <select
                  value={apiProfile}
                  onChange={(e) => setApiProfile(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 dark:border-white/20 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"
                >
                  {Object.keys(computePrices.api).map((profile) => (
                    <option key={profile} value={profile}>
                      {profile} — ${computePrices.api[profile]}/hr
                    </option>
                  ))}
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">API Replicas</label>
                <input
                  type="number"
                  min={1}
                  step={1}
                  inputMode="numeric"
                  value={apiReplicas}
                  onChange={(e) => setApiReplicas(clampInt(Number(e.target.value), 1))}
                  className="w-full px-3 py-2 border border-gray-300 dark:border-white/20 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"
                />
              </div>

              <div>
                <label className="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Processor Profile</label>
                <select
                  value={processorProfile}
                  onChange={(e) => setProcessorProfile(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 dark:border-white/20 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"
                >
                  {Object.keys(computePrices.processor).map((profile) => (
                    <option key={profile} value={profile}>
                      {profile} — ${computePrices.processor[profile]}/hr
                    </option>
                  ))}
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Processor Count</label>
                <input
                  type="number"
                  min={1}
                  step={1}
                  inputMode="numeric"
                  value={processorCount}
                  onChange={(e) => setProcessorCount(clampInt(Number(e.target.value), 1))}
                  className="w-full px-3 py-2 border border-gray-300 dark:border-white/20 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"
                />
              </div>

              <div>
                <label className="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Database Profile</label>
                <select
                  value={databaseProfile}
                  onChange={(e) => setDatabaseProfile(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 dark:border-white/20 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"
                >
                  {Object.keys(computePrices.database).map((profile) => (
                    <option key={profile} value={profile}>
                      {profile} — ${computePrices.database[profile]}/hr
                    </option>
                  ))}
                </select>
              </div>
            </>
          )}

          {/* Storage */}
          <div>
            <label className="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">Storage (GB)</label>
            <input
              type="number"
              min={0}
              step={10}
              inputMode="numeric"
              value={storageGB}
              onChange={(e) => setStorageGB(clampFloat(Number(e.target.value), 0))}
              className="w-full px-3 py-2 border border-gray-300 dark:border-white/20 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"
            />
          </div>

          {/* RPC */}
          <div>
            <label className="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">RPC Requests per Month</label>
            <input
              type="number"
              min={0}
              step={100000}
              inputMode="numeric"
              value={rpcRequests}
              onChange={(e) => setRpcRequests(clampInt(Number(e.target.value), 0))}
              className="w-full px-3 py-2 border border-gray-300 dark:border-white/20 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"
            />
            <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">First 2M requests are free.</p>
          </div>

          {/* Hibernated */}
          <div>
            <label className="flex items-center cursor-pointer">
              <input
                type="checkbox"
                checked={hibernated}
                onChange={(e) => setHibernated(e.target.checked)}
                className="mr-2"
              />
              <span className="text-gray-900 dark:text-gray-200">Hibernated (only storage costs apply)</span>
            </label>
          </div>

          {/* Results */}
          <div className="border-t border-gray-200 dark:border-white/10 pt-4 mt-4">
            <div className="space-y-2">
              <div className="flex justify-between text-sm">
                <span className="text-gray-600 dark:text-gray-400">Compute ({hibernated ? "hibernated" : "24/7"}):</span>
                <span className="font-medium text-gray-900 dark:text-gray-200">{fmt(computeCost)}/mo</span>
              </div>
              <div className="flex justify-between text-sm">
                <span className="text-gray-600 dark:text-gray-400">Storage ({clampFloat(storageGB, 0)} GB):</span>
                <span className="font-medium text-gray-900 dark:text-gray-200">{fmt(storageCost)}/mo</span>
              </div>
              {rpcRequests > 0 && (
                <div className="flex justify-between text-sm">
                  <span className="text-gray-600 dark:text-gray-400">
                    RPC ({rpcRequests > rpcFreeMonthly ? ((rpcRequests - rpcFreeMonthly) / 1000000).toFixed(2) + "M excess" : "within free tier"}):
                  </span>
                  <span className="font-medium text-gray-900 dark:text-gray-200">{fmt(rpcCost)}/mo</span>
                </div>
              )}
              <div className="flex justify-between text-lg font-semibold pt-2 border-t border-gray-200 dark:border-white/10">
                <span className="text-gray-900 dark:text-gray-200">Total Monthly Cost:</span>
                <span className="text-blue-600 dark:text-blue-400">{fmt(totalCost)}/mo</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

);
}
